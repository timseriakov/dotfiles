#!/usr/bin/env bash
set -euo pipefail

PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

REPO="$HOME/dev/dotfiles/battery"
BACKUP_FILE="$REPO/config/pmset.before-server.env"

KEYS=(
  sleep
  disksleep
  displaysleep
  standby
  autopoweroff
  hibernatemode
  tcpkeepalive
  powernap
  womp
)

log() {
  echo "[pmset-server] $*"
}

extract_value() {
  local section="$1"
  local key="$2"
  pmset -g custom | awk -v section="$section" -v key="$key" '
    $0 == section ":" { in_section=1; next }
    /:$/ && $0 != section ":" { in_section=0 }
    in_section && $1 == key { print $2; exit }
  '
}

save_current_pmset() {
  local tmp
  tmp=$(mktemp "${BACKUP_FILE}.tmp.XXXX")

  {
    echo "# Auto-generated by pmset-server.sh"
    for key in "${KEYS[@]}"; do
      b_value=$(extract_value "Battery Power" "$key" || true)
      c_value=$(extract_value "AC Power" "$key" || true)
      echo "B_${key}=${b_value:-}"
      echo "C_${key}=${c_value:-}"
    done
  } >"$tmp"

  mv "$tmp" "$BACKUP_FILE"
  log "saved current pmset profile to $BACKUP_FILE"
}

apply_server_profile() {
  sudo pmset -a sleep 0
  sudo pmset -a disksleep 0
  sudo pmset -a displaysleep 5
  sudo pmset -a standby 0
  sudo pmset -a autopoweroff 0
  sudo pmset -a hibernatemode 0
  sudo pmset -a tcpkeepalive 1
  sudo pmset -a powernap 1
  sudo pmset -a womp 1
}

main() {
  save_current_pmset
  apply_server_profile
  log "server power profile applied"
  pmset -g custom
}

main "$@"
