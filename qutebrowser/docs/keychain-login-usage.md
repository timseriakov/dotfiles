# Apple Passwords (keychain-login) — Использование

## Требования

```bash
# Установка apw (Apple Passwords CLI)
brew install bendews/homebrew-tap/apw

# Запуск службы apw
brew services start apw

# Первичная авторизация (один раз)
apw auth
```

## Горячие клавиши в qutebrowser

| Клавиши | Действие |
|---------|----------|
| `Space p` | Автозаполнение формы первой найденной записью Apple Passwords |
| `Space P` | Показать список всех записей для выбора (режим `--pick`) |
| `Ctrl+Shift+K` | Альтернативный бинд для автозаполнения |

## Как это работает

1. **Нажатие `Space p`** на странице с формой входа
2. Скрипт извлекает домен из URL (например, `github.com`)
3. Показывает toast: **"Apple Passwords: ищу записи для github.com"**
4. Запрашивает `apw pw list <domain>` для поиска записей
5. **Если требуется авторизация**:
   - Открывается окно Alacritty с запросом Touch ID
   - Один раз вводите код подтверждения → Enter
   - Окно закрывается автоматически после успеха
6. **Если записей несколько** (или нажат `Space P`):
   - Появляется системное окно выбора через `osascript`
   - Выбираете нужную запись из списка
7. Скрипт получает пароль через `apw pw get`
8. **JavaScript инжектится в страницу**:
   - Находит поля `input[type="email"]`, `input[type="password"]`, etc.
   - Заполняет логин и пароль
   - Устанавливает фокус на форму
9. Показывает toast: **"Apple Passwords: user@example.com • github.com"**

## Логирование

Все действия записываются в `/tmp/keychain-login.log`:

```bash
# Просмотр лога в реальном времени
tail -f /tmp/keychain-login.log

# Последние ошибки
grep ERROR /tmp/keychain-login.log
```

Формат лога:
```
[2025-11-05 22:35:12] ========== Новая сессия keychain-login ==========
[2025-11-05 22:35:12] URL: https://github.com/login
[2025-11-05 22:35:12] Извлечён домен: github.com (нижний регистр: github.com)
[2025-11-05 22:35:12] Запрос: apw pw list 'github.com'
[2025-11-05 22:35:13] apw pw list exit code: 0
[2025-11-05 22:35:13] JSON status code: 0
[2025-11-05 22:35:13] Найдено записей: 1
[2025-11-05 22:35:13] Автоматически выбрана единственная запись
[2025-11-05 22:35:14] Пароль успешно получен, длина: 32 символов
[2025-11-05 22:35:14] JavaScript сгенерирован, размер: 4256 байт
[2025-11-05 22:35:14] Успешное завершение: user@github.com • github.com
[2025-11-05 22:35:14] ========== Конец сессии ==========
```

## Обработка ошибок

### Нет записей для домена
Toast: **"В Apple Паролях нет записей для example.com"**
- Добавьте запись в Apple Passwords (Системные настройки → Пароли)
- Убедитесь, что домен совпадает с URL страницы

### Требуется авторизация
Toast: **"Требуется авторизация Apple Passwords..."**
- Откроется окно Alacritty с запросом Touch ID
- Введите код подтверждения один раз
- Если ошибка повторяется, выполните вручную: `apw auth`

### Поля не найдены
Toast (на странице): **"❌ Поля для ввода не найдены на странице"**
- Страница использует нестандартные селекторы полей
- Откройте DevTools (`Space d d`) и проверьте структуру формы
- Сообщите о проблеме с указанием URL

### Служба apw не запущена
Toast: **"Служба apw не запущена. Запустите: brew services start apw"**
```bash
brew services start apw
```

## Безопасность

- **Пароли не хранятся** в скрипте или логах (только длина строки)
- **Touch ID** требуется при каждом запросе пароля (через macOS API)
- **Логи** содержат только метаданные (username, domain, статусы)
- **JavaScript** выполняется локально в странице без внешних запросов

## Отладка

### Проверка работы apw вручную
```bash
# Список записей для домена
apw pw list github.com

# Получение пароля
apw pw get github.com your-email@example.com

# Авторизация
apw auth
```

### Проверка qutebrowser биндов
В qutebrowser введите `:bind` и найдите:
```
Space p → spawn -u keychain-login
Space P → spawn -u keychain-login --pick
```

### Проверка процесса userscript
В qutebrowser после выполнения:
```
:process
```
Покажет статус выполнения userscript и ошибки (если есть).

## Известные ограничения

- **SPA с динамическим DOM**: Если поля появляются после загрузки, может потребоваться повторное нажатие `Space p`
- **iFrame формы**: JavaScript не может получить доступ к полям внутри iframe (ограничение браузера)
- **Нестандартные поля**: Некоторые сайты используют кастомные компоненты вместо `<input>` — может не работать

## Альтернативные инструменты

Если keychain-login не подходит, рассмотрите:
- **pass** (менеджер паролей через GPG) — см. существующие биинды в `config.py`
- **1Password CLI** (`op`) — требует доработки скрипта
- **Bitwarden CLI** (`bw`) — требует доработки скрипта

---

**Автор скрипта**: Claude Code
**Версия**: 2.0 (ноябрь 2025)
**Лицензия**: См. LICENSE в корне репозитория
