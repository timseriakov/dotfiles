#!/bin/bash
# –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º —á–µ—Ä–µ–∑ Apple Passwords (apw CLI)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   keychain-login            # –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
#   keychain-login --pick     # –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: brew install bendews/homebrew-tap/apw && brew services start apw

set -euo pipefail

export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

# ========== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ==========
DEBUG_LOG="/tmp/keychain-login.log"
PICK_MODE=false
ATTEMPTED_AUTH=false

# ========== –£—Ç–∏–ª–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ==========
log() {
  local timestamp
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  {
    printf '[%s] %s\n' "$timestamp" "$*"
  } >>"$DEBUG_LOG" 2>&1 || true
}

send_message() {
  local level="$1"
  shift
  local text="$*"
  local escaped
  escaped=$(printf '%s' "$text" | sed 's/\\/\\\\/g; s/"/\\"/g')
  printf 'message-%s "%s"\n' "$level" "$escaped" >>"$QUTE_FIFO"
}

die() {
  log "ERROR: $*"
  send_message error "$*"
  exit 1
}

# ========== –ü—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è ==========
[[ -z "${QUTE_URL:-}" ]] || [[ -z "${QUTE_FIFO:-}" ]] && die "–î–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∫ userscript qutebrowser"

# –°–æ–∑–¥–∞—ë–º –ª–æ–≥-—Ñ–∞–π–ª –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
touch "$DEBUG_LOG" 2>/dev/null || true
log "========== –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è keychain-login =========="
log "URL: $QUTE_URL"

# ========== –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ==========
while [[ $# -gt 0 ]]; do
  case "$1" in
  -p | --pick)
    PICK_MODE=true
    log "–í–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∑–∞–ø–∏—Å–∏ (--pick)"
    ;;
  -h | --help)
    send_message info "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: keychain-login [--pick]"
    exit 0
    ;;
  *)
    die "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: $1"
    ;;
  esac
  shift
done

# ========== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ==========
for cmd in jq python3; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    die "–ö–æ–º–∞–Ω–¥–∞ '$cmd' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install $cmd"
  fi
done

if [[ -n "${APW_BIN:-}" ]]; then
  [[ ! -x "$APW_BIN" ]] && die "–£–∫–∞–∑–∞–Ω–Ω—ã–π APW_BIN='$APW_BIN' –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π"
else
  if ! command -v apw >/dev/null 2>&1; then
    die "–ö–æ–º–∞–Ω–¥–∞ 'apw' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install bendews/homebrew-tap/apw && brew services start apw"
  fi
  APW_BIN="$(command -v apw)"
fi

log "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è apw: $APW_BIN"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É–∂–±—ã apw
if ! pgrep -x "apw" >/dev/null 2>&1; then
  send_message warning "–°–ª—É–∂–±–∞ apw –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: brew services start apw"
  log "WARNING: –ü—Ä–æ—Ü–µ—Å—Å apw –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ pgrep"
fi

# ========== –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ ==========
DOMAIN=$(echo "$QUTE_URL" | sed -E 's|^https?://([^/]+).*|\1|' | sed 's/^www\.//')
DOMAIN_LOWER=$(printf '%s' "$DOMAIN" | tr '[:upper:]' '[:lower:]')

log "–ò–∑–≤–ª–µ—á—ë–Ω –¥–æ–º–µ–Ω: $DOMAIN (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä: $DOMAIN_LOWER)"
send_message info "Apple Passwords: –∏—â—É –∑–∞–ø–∏—Å–∏ –¥–ª—è $DOMAIN"

# ========== –ü–æ–∏—Å–∫ Alacritty –¥–ª—è –æ–∫–Ω–∞ auth ==========
find_alacritty() {
  for path in "/opt/homebrew/bin/alacritty" "/usr/local/bin/alacritty"; do
    if [[ -x "$path" ]]; then
      printf '%s' "$path"
      return 0
    fi
  done
  if command -v alacritty >/dev/null 2>&1; then
    command -v alacritty
    return 0
  fi
  return 1
}

# ========== –ó–∞–ø—É—Å–∫ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ apw ==========
launch_apw_auth() {
  local alacritty_bin

  log "–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ apw auth"

  if ! alacritty_bin=$(find_alacritty); then
    log "Alacritty –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫ apw auth –Ω–∞–ø—Ä—è–º—É—é"
    "$APW_BIN" auth
    return $?
  fi

  log "–ù–∞–π–¥–µ–Ω Alacritty: $alacritty_bin"

  # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  local temp_script
  temp_script=$(mktemp /tmp/apw-auth.XXXXXX)

  if [[ -z "$temp_script" ]]; then
    log "ERROR: mktemp –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª"
    die "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è auth"
  fi

  # –í–ê–ñ–ù–û: heredoc –ë–ï–ó –∫–∞–≤—ã—á–µ–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  cat >"$temp_script" <<AUTHSCRIPT
#!/bin/bash
set -euo pipefail

export PATH="$PATH"

CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "\${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\${NC}"
echo -e "\${CYAN}‚ïë      Apple Passwords - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è             ‚ïë\${NC}"
echo -e "\${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\${NC}"
echo ""
echo -e "\${YELLOW}Touch ID –∑–∞–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ.\${NC}"
echo -e "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ Enter."
echo ""

"$APW_BIN" auth
status=\$?

echo ""
if [[ \$status -eq 0 ]]; then
    echo -e "\${GREEN}‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!\${NC}"
else
    echo -e "\${RED}‚úó apw auth –≤–µ—Ä–Ω—É–ª –∫–æ–¥ –æ—à–∏–±–∫–∏: \$status\${NC}"
fi

echo ""
echo -e "\${YELLOW}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞...\${NC}"
read -r
exit \$status
AUTHSCRIPT

  chmod +x "$temp_script"
  log "–°–æ–∑–¥–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç auth: $temp_script"

  # –ó–∞–ø—É—Å–∫ Alacritty —Å –æ–∫–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –∂–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
  log "–ó–∞–ø—É—Å–∫ Alacritty: $alacritty_bin"

  set +e
  "$alacritty_bin" \
    --title "Apple Passwords - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" \
    --option window.dimensions.columns=50 \
    --option window.dimensions.lines=15 \
    --command "$temp_script" 2>>"$DEBUG_LOG"
  local exit_code=$?
  set -e

  log "Alacritty –∑–∞–≤–µ—Ä—à—ë–Ω —Å –∫–æ–¥–æ–º: $exit_code"
  rm -f "$temp_script"
  return $exit_code
}

# ========== –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ apw ==========
query_apw_list() {
  local domain="$1"
  local output status

  log "–ó–∞–ø—Ä–æ—Å: apw pw list '$domain'"

  set +e
  output=$("$APW_BIN" pw list "$domain" 2>&1)
  local exit_code=$?
  set -e

  log "apw pw list exit code: $exit_code"
  log "apw pw list output: $output"

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON —Å—Ç–∞—Ç—É—Å
  if ! status=$(printf '%s' "$output" | jq -r '.status // "unknown"' 2>/dev/null); then
    log "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç apw pw list"
    printf '%s' "$output"
    return "$exit_code"
  fi

  log "JSON status code: $status"

  case "$status" in
  0)
    # –£—Å–ø–µ—Ö
    printf '%s' "$output"
    return 0
    ;;
  1)
    # Timeout - –≤–æ–∑–º–æ–∂–Ω–æ, apw auth —É–∂–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –∑–∞–≤–∏—Å–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    log "Timeout –æ—Ç apw (status=1) - –≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–≤–∏—Å–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
    die "apw timeout: –≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—É—â–µ–Ω–∞ –¥—Ä—É–≥–∞—è —Å–µ—Å—Å–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É: brew services restart apw"
    ;;
  3)
    # –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π
    log "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –¥–æ–º–µ–Ω–∞ $domain (status=3)"
    printf '%s' "$output"
    return 3
    ;;
  2 | 4 | 5 | 9)
    # –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (9=missing encryption key, 2/4/5=unauthorized)
    log "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (status=$status)"

    if [[ $ATTEMPTED_AUTH == false ]]; then
      ATTEMPTED_AUTH=true
      send_message info "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Apple Passwords..."

      if launch_apw_auth; then
        log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è—é –∑–∞–ø—Ä–æ—Å apw pw list"
        sleep 1
        query_apw_list "$domain" # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ auth
        return $?
      else
        die "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è apw –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
      fi
    else
      die "apw —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –Ω–æ –ø–æ–ø—ã—Ç–∫–∞ —É–∂–µ –±—ã–ª–∞"
    fi
    ;;
  *)
    local error_msg
    error_msg=$(printf '%s' "$output" | jq -r '.error // "–û—à–∏–±–∫–∞ apw"' 2>/dev/null)
    log "apw pw list –≤–µ—Ä–Ω—É–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å $status: $error_msg"
    die "apw: $error_msg"
    ;;
  esac
}

# ========== –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ apw ==========
query_apw_get() {
  local service="$1"
  local username="${2:-}"
  local output status

  local cmd=("$APW_BIN" pw get "$service")
  [[ -n "$username" ]] && cmd+=("$username")

  log "–ó–∞–ø—Ä–æ—Å: ${cmd[*]}"

  set +e
  output=$("${cmd[@]}" 2>&1)
  local exit_code=$?
  set -e

  log "apw pw get exit code: $exit_code"
  log "apw pw get output length: ${#output}"

  if ! status=$(printf '%s' "$output" | jq -r '.status // "unknown"' 2>/dev/null); then
    log "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç apw pw get"

    # –ï—Å–ª–∏ —É–∂–µ –ø—ã—Ç–∞–ª–∏—Å—å auth, –æ—à–∏–±–∫–∞
    if [[ $ATTEMPTED_AUTH == true ]]; then
      die "apw pw get –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω—ã–π JSON –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    fi

    # –ü—ã—Ç–∞–µ–º—Å—è auth –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
    ATTEMPTED_AUTH=true
    send_message info "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è..."
    if launch_apw_auth; then
      log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è—é apw pw get"
      sleep 1
      query_apw_get "$service" "$username"
      return $?
    else
      die "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è apw –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
    fi
  fi

  log "JSON status code: $status"

  case "$status" in
  0)
    printf '%s' "$output"
    return 0
    ;;
  2 | 4 | 5 | 9)
    if [[ $ATTEMPTED_AUTH == false ]]; then
      ATTEMPTED_AUTH=true
      send_message info "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è..."
      if launch_apw_auth; then
        log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è—é apw pw get"
        sleep 1
        query_apw_get "$service" "$username"
        return $?
      else
        die "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è apw –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
      fi
    else
      die "apw —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è get, –Ω–æ –ø–æ–ø—ã—Ç–∫–∞ —É–∂–µ –±—ã–ª–∞"
    fi
    ;;
  *)
    local error_msg
    error_msg=$(printf '%s' "$output" | jq -r '.error // "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å"' 2>/dev/null)
    die "apw pw get: $error_msg (status=$status)"
    ;;
  esac
}

# ========== –ü–æ–ª—É—á–µ–Ω–∏–µ OTP —á–µ—Ä–µ–∑ apw ==========
query_apw_otp() {
  local service="$1"
  local username="${2:-}"
  local output status

  local cmd=("$APW_BIN" otp get "$service")
  [[ -n "$username" ]] && cmd+=("$username")

  log "–ó–∞–ø—Ä–æ—Å OTP: ${cmd[*]}"

  set +e
  output=$("${cmd[@]}" 2>&1)
  local exit_code=$?
  set -e

  log "apw otp get exit code: $exit_code"
  log "apw otp get output length: ${#output}"

  if ! status=$(printf '%s' "$output" | jq -r '.status // "unknown"' 2>/dev/null); then
    log "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç apw otp get"

    # –ï—Å–ª–∏ —É–∂–µ –ø—ã—Ç–∞–ª–∏—Å—å auth, –æ—à–∏–±–∫–∞
    if [[ $ATTEMPTED_AUTH == true ]]; then
      log "apw otp get –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω—ã–π JSON –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ—Ç OTP)"
      printf '{"status":3,"error":"No OTP found"}'
      return 3
    fi

    # –ü—ã—Ç–∞–µ–º—Å—è auth –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
    ATTEMPTED_AUTH=true
    send_message info "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è OTP..."
    if launch_apw_auth; then
      log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è—é apw otp get"
      sleep 1
      query_apw_otp "$service" "$username"
      return $?
    else
      log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è apw –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è OTP"
      printf '{"status":3,"error":"No OTP found"}'
      return 3
    fi
  fi

  log "JSON status code –¥–ª—è OTP: $status"

  case "$status" in
  0)
    # –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω OTP
    printf '%s' "$output"
    return 0
    ;;
  3)
    # –ù–µ—Ç OTP –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ (—ç—Ç–æ –Ω–æ—Ä–º, –Ω–µ –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç OTP)
    log "–ù–µ—Ç OTP –¥–ª—è $service / $username (status=3)"
    printf '%s' "$output"
    return 3
    ;;
  2 | 4 | 5 | 9)
    if [[ $ATTEMPTED_AUTH == false ]]; then
      ATTEMPTED_AUTH=true
      send_message info "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è OTP..."
      if launch_apw_auth; then
        log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–æ–≤—Ç–æ—Ä—è—é apw otp get"
        sleep 1
        query_apw_otp "$service" "$username"
        return $?
      else
        log "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è apw –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è OTP"
        printf '{"status":3,"error":"No OTP found"}'
        return 3
      fi
    else
      log "apw —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è otp get, –Ω–æ –ø–æ–ø—ã—Ç–∫–∞ —É–∂–µ –±—ã–ª–∞"
      printf '{"status":3,"error":"No OTP found"}'
      return 3
    fi
    ;;
  *)
    local error_msg
    error_msg=$(printf '%s' "$output" | jq -r '.error // "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å OTP"' 2>/dev/null)
    log "apw otp get: $error_msg (status=$status)"
    printf '{"status":3,"error":"No OTP found"}'
    return 3
    ;;
  esac
}

# ========== –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ fzf (Nord theme) ==========
select_entry_fzf() {
  local domain="$1"
  shift
  local entries=("$@")

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è fzf
  if ! command -v fzf >/dev/null 2>&1; then
    log "fzf –Ω–µ –Ω–∞–π–¥–µ–Ω, fallback –Ω–∞ osascript"
    select_entry_osascript "$domain" "${entries[@]}"
    return $?
  fi

  # –ü–æ–∏—Å–∫ Alacritty
  local alacritty_bin
  if ! alacritty_bin=$(find_alacritty); then
    log "Alacritty –Ω–µ –Ω–∞–π–¥–µ–Ω, fallback –Ω–∞ osascript"
    select_entry_osascript "$domain" "${entries[@]}"
    return $?
  fi

  log "–ò—Å–ø–æ–ª—å–∑—É–µ–º fzf –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–∞–ø–∏—Å–∏ (Alacritty: $alacritty_bin)"

  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç TSV –¥–ª—è fzf
  # –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: username@service ‚Ä¢ label (–µ—Å–ª–∏ label != service)
  local fzf_input=""
  local display_to_entry=()

  for entry in "${entries[@]}"; do
    IFS=$'\t' read -r username service label _uuid <<<"$entry"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É
    local display="${username}@${service}"
    [[ -n "$label" && "$label" != "$service" ]] && display="${display} ‚Ä¢ ${label}"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º mapping display -> original entry
    display_to_entry+=("$display|$entry")

    # –î–æ–±–∞–≤–ª—è–µ–º –≤ input –¥–ª—è fzf (TSV: display<tab>username<tab>service<tab>label)
    fzf_input+="${display}"$'\t'"${username}"$'\t'"${service}"$'\t'"${label}"$'\n'
  done

  # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è fzf –æ–∫–Ω–∞
  local temp_script
  temp_script=$(mktemp /tmp/fzf-select.XXXXXX)

  if [[ -z "$temp_script" ]]; then
    log "ERROR: mktemp –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è fzf"
    select_entry_osascript "$domain" "${entries[@]}"
    return $?
  fi

  log "–°–æ–∑–¥–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç fzf: $temp_script"

  # –°–∫—Ä–∏–ø—Ç —Å Nord —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º–æ–π –∏ preview
  cat >"$temp_script" <<'FZFSCRIPT'
#!/bin/bash
set -euo pipefail

export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Nord theme colors –¥–ª—è fzf
export FZF_DEFAULT_OPTS="
--ansi
--height=100%
--layout=reverse
--border=rounded
--border-label=' Apple Passwords - –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ '
--border-label-pos=3
--prompt=' ‚ùØ '
--pointer='‚ñ∂'
--marker='‚úì'
--info=inline
--delimiter=$'\t'
--with-nth=1
--preview='echo -e \"‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ\n‚îÇ üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {2}\n‚îÇ üåê –î–æ–º–µ–Ω: {3}\n‚îÇ üè∑Ô∏è  –ú–µ—Ç–∫–∞: {4}\n‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\n\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞\n–∏–ª–∏ Esc –¥–ª—è –æ—Ç–º–µ–Ω—ã\"'
--preview-window=up:9:border-rounded:wrap
--color=fg:#e5e9f0,bg:#2e3440,hl:#88c0d0
--color=fg+:#e5e9f0,bg+:#3b4252,hl+:#88c0d0
--color=info:#81a1c1,prompt:#81a1c1,pointer:#88c0d0
--color=marker:#a3be8c,spinner:#81a1c1,header:#88c0d0
--color=border:#4c566a,label:#81a1c1
--color=preview-fg:#d8dee9,preview-bg:#2e3440
--color=preview-border:#4c566a
"

# –ß–∏—Ç–∞–µ–º TSV –¥–∞–Ω–Ω—ã–µ –∏–∑ stdin –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fzf
result=$(cat | fzf)
exit_code=$?

if [[ $exit_code -eq 0 && -n "$result" ]]; then
  echo "$result"
  exit 0
elif [[ $exit_code -eq 130 ]]; then
  # Ctrl-C / Esc
  echo "__CANCELLED__"
  exit 0
else
  echo "__CANCELLED__"
  exit 1
fi
FZFSCRIPT

  chmod +x "$temp_script"

  # –ó–∞–ø—É—Å–∫ Alacritty —Å fzf
  local selected
  set +e
  selected=$(printf '%s' "$fzf_input" | "$alacritty_bin" \
    --title "Apple Passwords - –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏" \
    --option window.dimensions.columns=120 \
    --option window.dimensions.lines=25 \
    --command "$temp_script" 2>>"$DEBUG_LOG")
  local exit_code=$?
  set -e

  rm -f "$temp_script"

  if [[ $exit_code -ne 0 || "$selected" == "__CANCELLED__" || -z "$selected" ]]; then
    log "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä fzf"
    printf '__CANCELLED__'
    return 0
  fi

  # selected —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —Ç–∞–±–∞–º–∏: "display\tusername\tservice\tlabel"
  # –ò–∑–≤–ª–µ–∫–∞–µ–º display (–ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ)
  local display_selected
  display_selected=$(echo "$selected" | cut -f1)

  log "–í—ã–±—Ä–∞–Ω–æ —á–µ—Ä–µ–∑ fzf: $display_selected"

  # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é entry
  for mapping in "${display_to_entry[@]}"; do
    local display_part="${mapping%%|*}"
    local entry_part="${mapping#*|}"

    if [[ "$display_part" == "$display_selected" ]]; then
      printf '%s' "$entry_part"
      return 0
    fi
  done

  # Fallback –Ω–∞ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏
  log "–ù–µ –Ω–∞—à–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ fzf, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å"
  printf '%s' "${entries[0]}"
}

# ========== –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ osascript ==========
select_entry_osascript() {
  local domain="$1"
  shift
  local entries=("$@")

  local osa_list=""
  local first_item=""
  local displays=()
  local idx=0

  for entry in "${entries[@]}"; do
    IFS=$'\t' read -r username service label _uuid <<<"$entry"

    local display="${username}@${service}"
    [[ -n "$label" && "$label" != "$service" ]] && display="${display} (${label})"

    displays+=("$display")

    local escaped
    escaped=$(printf '%s' "$display" | sed 's/\\/\\\\/g; s/"/\\"/g')
    osa_list+="\"$escaped\""

    if [[ $idx -lt $((${#entries[@]} - 1)) ]]; then
      osa_list+=", "
    fi

    [[ $idx -eq 0 ]] && first_item="$escaped"
    idx=$((idx + 1))
  done

  local prompt
  prompt=$(printf '%s' "–ù–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π Apple Passwords –¥–ª—è ${domain}. –í—ã–±–µ—Ä–∏—Ç–µ:" | sed 's/\\/\\\\/g; s/"/\\"/g')

  local output
  output=$(
    osascript <<OSASCRIPT
set itemsList to {${osa_list}}
set chosen to choose from list itemsList with prompt "${prompt}" default items {"${first_item}"} without multiple selections allowed
if chosen is false then return "__CANCELLED__"
return item 1 of chosen
OSASCRIPT
  )

  if [[ "$output" == "__CANCELLED__" ]]; then
    log "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏"
    printf '__CANCELLED__'
    return 0
  fi

  # –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
  local i=0
  for display in "${displays[@]}"; do
    if [[ "$display" == "$output" ]]; then
      printf '%s' "${entries[$i]}"
      return 0
    fi
    i=$((i + 1))
  done

  # Fallback –Ω–∞ –ø–µ—Ä–≤—É—é
  log "–ù–µ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å"
  printf '%s' "${entries[0]}"
}

# ========== –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ==========

# –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –ø–∞—Ä–æ–ª–µ–π
LIST_JSON=$(query_apw_list "$DOMAIN_LOWER")
LIST_STATUS=$?

if [[ $LIST_STATUS -eq 3 ]]; then
  send_message error "–í Apple –ü–∞—Ä–æ–ª—è—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è $DOMAIN"
  log "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π"
  exit 0
fi

if [[ $LIST_STATUS -ne 0 ]]; then
  die "apw pw list –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º $LIST_STATUS"
fi

# –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
RESULTS=()
while IFS=$'\t' read -r username service label uuid; do
  [[ -z "$username" && -z "$service" ]] && continue
  printf -v entry '%s\t%s\t%s\t%s' "$username" "${service:-$DOMAIN_LOWER}" "$label" "$uuid"
  RESULTS+=("$entry")
done < <(printf '%s' "$LIST_JSON" | jq -r --arg domain "$DOMAIN_LOWER" '
    .results[]? |
    [
        (.username // .user // .account // .email // ""),
        (.domain // .service // .website // .url // .title // $domain),
        (.name // .title // .label // .displayName // ""),
        (.uuid // .id // .identifier // "")
    ] | @tsv
')

log "–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${#RESULTS[@]}"

if [[ ${#RESULTS[@]} -eq 0 ]]; then
  send_message error "–í Apple –ü–∞—Ä–æ–ª—è—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è $DOMAIN"
  log "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞"
  exit 0
fi

# –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏
SELECTED=""
if [[ ${#RESULTS[@]} -eq 1 && $PICK_MODE == false ]]; then
  SELECTED="${RESULTS[0]}"
  log "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å"
else
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º fzf —Å fallback –Ω–∞ osascript
  SELECTED=$(select_entry_fzf "$DOMAIN" "${RESULTS[@]}")
  if [[ "$SELECTED" == "__CANCELLED__" ]]; then
    send_message info "–í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ Apple –ü–∞—Ä–æ–ª–µ–π –æ—Ç–º–µ–Ω—ë–Ω"
    log "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä"
    exit 0
  fi
fi

IFS=$'\t' read -r USERNAME SERVICE LABEL _uuid <<<"$SELECTED"
log "–í—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å: username=$USERNAME, service=$SERVICE, label=$LABEL"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
GET_JSON=$(query_apw_get "$SERVICE" "$USERNAME")
PASSWORD=$(printf '%s' "$GET_JSON" | jq -r '.results[0].password // empty' 2>/dev/null)

if [[ -z "$PASSWORD" ]]; then
  die "apw –Ω–µ –≤–µ—Ä–Ω—É–ª –ø–∞—Ä–æ–ª—å (–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)"
fi

log "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞: ${#PASSWORD} —Å–∏–º–≤–æ–ª–æ–≤"

# –ï—Å–ª–∏ username –Ω–µ –±—ã–ª —É–∫–∞–∑–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
if [[ -z "$USERNAME" ]]; then
  USERNAME=$(printf '%s' "$GET_JSON" | jq -r '.results[0].username // empty' 2>/dev/null)
  log "Username –∏–∑–≤–ª–µ—á—ë–Ω –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ apw pw get: $USERNAME"
fi

# –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å OTP –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏
OTP=""
log "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å OTP –¥–ª—è $SERVICE / $USERNAME"
set +e
OTP_JSON=$(query_apw_otp "$SERVICE" "$USERNAME")
OTP_STATUS=$?
set -e

if [[ $OTP_STATUS -eq 0 ]]; then
  # OTP —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω
  OTP=$(printf '%s' "$OTP_JSON" | jq -r '.code // empty' 2>/dev/null)
  if [[ -n "$OTP" ]]; then
    log "OTP —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω: $OTP"
  else
    log "OTP JSON –ø–æ–ª—É—á–µ–Ω, –Ω–æ code –ø—É—Å—Ç"
  fi
elif [[ $OTP_STATUS -eq 3 ]]; then
  # –ù–µ—Ç OTP –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
  log "–ù–µ—Ç OTP –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ (status=3)"
else
  # –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è OTP (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ OTP)
  log "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è OTP (status=$OTP_STATUS), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ OTP"
fi

# ========== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∏–Ω–∂–µ–∫—Ç JavaScript ==========
TMP_JS=$(mktemp /tmp/qute-keychain-login.XXXXXX.js)
trap 'rm -f "$TMP_JS"' EXIT

log "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JavaScript –¥–ª—è DOM injection"

QUTE_USERNAME="$USERNAME" \
  QUTE_PASSWORD="$PASSWORD" \
  QUTE_OTP="$OTP" \
  QUTE_SERVICE="$SERVICE" \
  QUTE_LABEL="$LABEL" \
  python3 - <<'PYSCRIPT' >"$TMP_JS"
import os, json
from string import Template

username = os.environ.get('QUTE_USERNAME', '')
password = os.environ.get('QUTE_PASSWORD', '')
otp = os.environ.get('QUTE_OTP', '')
service = os.environ.get('QUTE_SERVICE', '')
label = os.environ.get('QUTE_LABEL', '')

template = Template('''
(function() {
  const username = $username;
  const password = $password;
  const otp = $otp;
  const hasUsername = username.length > 0;
  const hasOtp = otp.length > 0;
  const service = $service;
  const label = $label;

  const usernameSelectors = [
    'input[type="email"]',
    'input[type="text"][name*="user" i]:not([name*="otp" i]):not([name*="code" i]):not([name*="token" i]):not([name*="verify" i]):not([inputmode="numeric"])',
    'input[type="text"][name*="email" i]:not([name*="code" i]):not([name*="verify" i])',
    'input[type="text"][name*="login" i]:not([name*="code" i]):not([name*="token" i])',
    'input[autocomplete="username"]',
    'input[autocomplete="email"]',
    'input[name="username"]',
    'input[name="email"]',
    'input[name="login"]',
    'input[name="log"]',
    'input[id*="user" i]:not([id*="otp" i]):not([id*="code" i]):not([id*="verify" i]):not([inputmode="numeric"])',
    'input[id*="email" i]:not([id*="code" i]):not([id*="verify" i])',
    'input[id*="login" i]:not([id*="code" i]):not([id*="token" i])',
    'input[id="user_login"]'
  ];

  const passwordSelectors = [
    'input[type="password"]',
    'input[autocomplete="current-password"]',
    'input[name="password"]',
    'input[name="pwd"]',
    'input[id*="pass" i]',
    'input[id="user_pass"]'
  ];

  const otpSelectors = [
    'input[type="text"][name*="otp" i]',
    'input[type="text"][name*="code" i]',
    'input[type="text"][name*="token" i]',
    'input[type="tel"][name*="code" i]',
    'input[type="number"][name*="code" i]',
    'input[autocomplete="one-time-code"]',
    'input[name="otp"]',
    'input[name="code"]',
    'input[name="token"]',
    'input[name="verification_code"]',
    'input[name="authenticator_code"]',
    'input[id*="otp" i]',
    'input[id*="code" i]',
    'input[id*="token" i]',
    'input[inputmode="numeric"]',
    'input[placeholder*="–∫–æ–¥" i]',
    'input[placeholder*="code" i]',
    'input[placeholder*="otp" i]',
    'input[name*="2fa" i]',
    'input[name*="mfa" i]',
    'input[id*="2fa" i]',
    'input[id*="mfa" i]',
    'input[name*="verify" i]',
    'input[name*="verification" i]',
    'input[id*="verify" i]',
    'input[placeholder*="verification" i]',
    'input[name*="totp" i]',
    'input[id*="totp" i]',
    'input[name*="sms" i]',
    'input[id*="sms" i]',
    'input[aria-label*="code" i]',
    'input[aria-label*="otp" i]',
    'input[aria-label*="verification" i]',
    'input[name*="pin" i]',
    'input[id*="pin" i]'
  ];

  const events = ['input', 'change', 'keyup'];

  const setValue = (field, value) => {
    if (!field) return false;

    try {
      const proto = Object.getPrototypeOf(field) || HTMLInputElement.prototype;
      const descriptor = Object.getOwnPropertyDescriptor(proto, 'value');
      if (descriptor && descriptor.set) {
        descriptor.set.call(field, value);
      } else {
        field.value = value;
      }
    } catch (e) {
      field.value = value;
    }

    field.setAttribute('value', value);

    for (const evt of events) {
      field.dispatchEvent(new Event(evt, { bubbles: true }));
    }

    return true;
  };

  const run = () => {
    let filled = 0;
    let usernameField = null;
    let passwordField = null;

    // –ü–æ–∏—Å–∫ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ username –ø–æ–ª—è
    if (hasUsername) {
      for (const selector of usernameSelectors) {
        const field = document.querySelector(selector);
        if (field && field.offsetParent !== null && !field.disabled && !field.readOnly) {
          usernameField = field;
          break;
        }
      }

      if (usernameField && setValue(usernameField, username)) {
        usernameField.focus();
        filled++;
      }
    }

    // –ü–æ–∏—Å–∫ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ password –ø–æ–ª—è
    for (const selector of passwordSelectors) {
      const field = document.querySelector(selector);
      if (field && field.offsetParent !== null && !field.disabled && !field.readOnly) {
        passwordField = field;
        break;
      }
    }

    if (passwordField && setValue(passwordField, password)) {
      if (!hasUsername) {
        passwordField.focus();
      }
      filled++;
    }

    // –ü–æ–∏—Å–∫ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ OTP –ø–æ–ª—è
    let otpField = null;
    if (hasOtp) {
      for (const selector of otpSelectors) {
        const field = document.querySelector(selector);
        if (field && field.offsetParent !== null && !field.disabled && !field.readOnly) {
          otpField = field;
          break;
        }
      }

      if (otpField && setValue(otpField, otp)) {
        otpField.focus();
        filled++;
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const notification = document.createElement('div');
    notification.style.cssText = 'position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;z-index:10000;font-family:-apple-system,system-ui,sans-serif;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:360px;';

    let infoLine = service || '';
    if (label && label !== service) {
      infoLine = infoLine ? infoLine + ' ‚Ä¢ ' + label : label;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π
    let expectedFields = 0;
    if (hasUsername) expectedFields++;
    if (password.length > 0) expectedFields++;
    if (hasOtp) expectedFields++;

    if (filled === expectedFields && filled > 0) {
      // –í—Å—ë –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
      notification.style.background = '#4CAF50';
      notification.style.color = 'white';
      let heading = 'üîê Apple Passwords';
      if (hasUsername && hasOtp) {
        heading += ': ' + username + ' + OTP';
      } else if (hasUsername) {
        heading += ': ' + username;
      } else if (hasOtp) {
        heading += ': OTP –∑–∞–ø–æ–ª–Ω–µ–Ω';
      }
      const subtitle = infoLine ? '<br><small>' + infoLine + '</small>' : '';
      notification.innerHTML = heading + subtitle;
    } else if (filled > 0) {
      // –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
      notification.style.background = '#FF9800';
      notification.style.color = 'white';
      notification.innerHTML = '‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ–π: ' + filled + ' –∏–∑ ' + expectedFields;
    } else {
      // –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
      notification.style.background = '#f44336';
      notification.style.color = 'white';
      notification.innerHTML = '‚ùå –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ';
    }

    document.body.appendChild(notification);

    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 6000);

    return filled;
  };

  // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
    return '–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ Apple Passwords: –æ–∂–∏–¥–∞–Ω–∏–µ DOMContentLoaded';
  }

  const filledCount = run();
  return '–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ Apple Passwords: –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ–π ' + filledCount;
})();
''')

js = template.substitute(
    username=json.dumps(username),
    password=json.dumps(password),
    otp=json.dumps(otp),
    service=json.dumps(service),
    label=json.dumps(label),
)

print(js)
PYSCRIPT

log "JavaScript —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, —Ä–∞–∑–º–µ—Ä: $(wc -c <"$TMP_JS") –±–∞–π—Ç"

# –ò–Ω–∂–µ–∫—Ç –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
echo "jseval --quiet --file $TMP_JS" >>"$QUTE_FIFO"

# –§–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
INFO_LINE=""
if [[ -n "$USERNAME" ]]; then
  INFO_LINE="$USERNAME"
  [[ -n "$SERVICE" ]] && INFO_LINE+=" ‚Ä¢ $SERVICE"
  [[ -n "$LABEL" && "$LABEL" != "$SERVICE" ]] && INFO_LINE+=" ‚Ä¢ $LABEL"
else
  INFO_LINE="${SERVICE:-$DOMAIN}"
  [[ -n "$LABEL" && "$LABEL" != "$SERVICE" ]] && INFO_LINE+=" ‚Ä¢ $LABEL"
fi

send_message info "Apple Passwords: $INFO_LINE"
log "–£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: $INFO_LINE"
log "========== –ö–æ–Ω–µ—Ü —Å–µ—Å—Å–∏–∏ =========="
