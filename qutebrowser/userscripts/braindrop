#!/bin/bash
set -euo pipefail

# Минимальный PATH для урезанной среды qutebrowser (macOS)
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/Users/tim/dev/dotfiles/qutebrowser/bin:$PATH"

# Поиск бинаря Alacritty
if [[ -x "/opt/homebrew/bin/alacritty" ]]; then
  term="/opt/homebrew/bin/alacritty"
else
  term="alacritty"
fi

# Используем конфиг для большого окна (windowed 9999x9999, font 17.5)
config_file="/Users/tim/dev/dotfiles/qutebrowser/alacritty-braindrop.toml"

# Уникальный класс для нашего braindrop окна
window_class="braindrop-terminal"

# Проверяем, запущено ли уже окно braindrop
if pgrep -f "braindrop" > /dev/null 2>&1; then
    # Активируем существующее окно через AppleScript
    osascript -e '
        tell application "System Events"
            set appProcess to first process whose name is "Alacritty"
            set frontmost of appProcess to true
        end tell
    ' 2>/dev/null || true

    exit 0
fi

# Если окна нет или не удалось активировать - запускаем новое
exec "$term" --config-file "$config_file" --class "$window_class" -e /bin/bash -c "BROWSER=\"$HOME/dev/dotfiles/bin/open-in-qute\" exec /Users/tim/.local/bin/braindrop"
