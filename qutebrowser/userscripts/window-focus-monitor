#!/bin/bash
# Monitor qutebrowser window focus and switch to English layout
# This script runs in the background and monitors when qutebrowser gains focus

set -euo pipefail

# Function to switch to English layout
switch_to_english() {
  if command -v im-select >/dev/null 2>&1; then
    im-select com.apple.keylayout.ABC 2>/dev/null || true
  fi
}

# Function to get the currently focused application
get_focused_app() {
  osascript -e 'tell application "System Events" to get name of first application process whose frontmost is true' 2>/dev/null || echo ""
}

# Function to check if qutebrowser is in insert mode
is_qutebrowser_in_insert_mode() {
  # Try to detect insert mode by checking if there's an active input field
  # This is a heuristic approach since we can't directly query qutebrowser's mode
  local focused_element
  focused_element=$(osascript -e '
    tell application "System Events"
      tell process "qutebrowser"
        try
          set focused_element to focused of UI element 1 of scroll area 1 of group 1 of group 1 of window 1
          return focused_element
        on error
          return false
        end try
      end tell
    end tell
  ' 2>/dev/null || echo "false")

  [[ "$focused_element" == "true" ]]
}

# Main monitoring loop
monitor_focus() {
  local last_focused=""
  local current_focused=""

  while true; do
    current_focused=$(get_focused_app)

    # Check if qutebrowser just gained focus
    if [[ "$current_focused" == "qutebrowser" && "$last_focused" != "qutebrowser" ]]; then
      # Small delay to let qutebrowser settle
      sleep 0.1

      # Only switch to English if not in insert mode
      if ! is_qutebrowser_in_insert_mode; then
        switch_to_english
      fi
    fi

    last_focused="$current_focused"
    sleep 0.5  # Check every 500ms
  done
}

# Run the monitor
monitor_focus
