#!/bin/bash

set -euo pipefail
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

FIFO=${QUTE_FIFO:-}
if [[ -z "${FIFO}" ]]; then
  echo "Must be run as qutebrowser userscript (QUTE_FIFO missing)" >&2
  exit 1
fi

# Clear engine-level user stylesheet both persistently and for this session
printf '%s\n' \
  "set content.user_stylesheets \"\"" \
  "set -t content.user_stylesheets \"\"" \
  > "$FIFO"

# Remove any page-injected styles and per-site flags
js='(function(){try{localStorage.setItem("qute-smart-dark","off");var ids=["qute-smart-dark-style","qute-dr-fallback"];ids.forEach(function(id){var el=document.getElementById(id);if(el&&el.parentNode){el.parentNode.removeChild(el);}});return true}catch(e){console.error(e);return false;}})()'
printf "jseval -q -- '%s'\n" "$js" > "$FIFO"

printf '%s\n' "message-info 'Dark styles reset (engine + per-site)'" > "$FIFO"

exit 0
