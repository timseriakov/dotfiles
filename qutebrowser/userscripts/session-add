#!/bin/bash

# Ensure Homebrew and system binaries are available inside Alacritty
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Пути
SESSION_DIR="$HOME/Library/Application Support/qutebrowser/sessions"
# Fallback для Linux
if [ ! -d "$SESSION_DIR" ]; then
  SESSION_DIR="$HOME/.local/share/qutebrowser/sessions"
fi

# ==============================================================================
# PREVIEW MODE (вызывается из fzf для отображения инфо о сессии)
# ==============================================================================
if [ "$1" == "--preview" ] && [ -n "$2" ]; then
  SESSION_FILE="$2"
  # Если путь не абсолютный, ищем в SESSION_DIR
  if [[ "$SESSION_FILE" != /* ]]; then
    SESSION_FILE="$SESSION_DIR/$SESSION_FILE"
  fi

  # Если расширение не указано, добавляем .yml
  if [[ "$SESSION_FILE" != *.yml ]]; then
    SESSION_FILE="$SESSION_FILE.yml"
  fi

  if [ ! -f "$SESSION_FILE" ]; then
    echo "File not found: $SESSION_FILE"
    exit 1
  fi

  # Python скрипт для генерации красивого превью
  python3 -c "
import sys, yaml

try:
    with open('$SESSION_FILE', 'r') as f:
        data = yaml.safe_load(f)

    windows = data.get('windows', [])
    total_wins = len(windows)
    total_tabs = 0

    print(f'  Session: {sys.argv[1]}')
    print(f'  Windows: {total_wins}')

    for idx, win in enumerate(windows, 1):
        tabs = win.get('tabs', [])
        total_tabs += len(tabs)
        print(f'\n  Window {idx} ({len(tabs)} tabs):')

        for t_idx, tab in enumerate(tabs, 1):
            history = tab.get('history', [])
            if not history: continue

            page = history[-1]
            title = page.get('title', 'No Title')

            if len(title) > 80: title = title[:77] + '...'

            marker = '' if tab.get('active') else ' '
            print(f'  {marker} {title}')

    print(f'\n  Total Tabs: {total_tabs}')

except Exception as e:
    print(f'Error reading session: {e}')
" "$(basename "$SESSION_FILE" .yml)"
  exit 0
fi

# ==============================================================================
# MAIN LOGIC
# ==============================================================================

# ==============================================================================
# PREVIEW MODE (вызывается из fzf для отображения инфо о сессии)
# ==============================================================================
if [ "$1" == "--preview" ] && [ -n "$2" ]; then
  SESSION_FILE="$2"
  # Если путь не абсолютный, ищем в SESSION_DIR
  if [[ "$SESSION_FILE" != /* ]]; then
    SESSION_FILE="$SESSION_DIR/$SESSION_FILE"
  fi

  # Если расширение не указано, добавляем .yml
  if [[ "$SESSION_FILE" != *.yml ]]; then
    SESSION_FILE="$SESSION_FILE.yml"
  fi

  if [ ! -f "$SESSION_FILE" ]; then
    echo "File not found: $SESSION_FILE"
    exit 1
  fi

  # Python скрипт для генерации красивого превью
  python3 -c "
import sys, yaml

try:
    with open('$SESSION_FILE', 'r') as f:
        data = yaml.safe_load(f)

    windows = data.get('windows', [])
    total_wins = len(windows)
    total_tabs = 0

    print(f'  Session: {sys.argv[1]}')
    print(f'  Windows: {total_wins}')

    for idx, win in enumerate(windows, 1):
        tabs = win.get('tabs', [])
        total_tabs += len(tabs)
        print(f'\n  Window {idx} ({len(tabs)} tabs):')

        for t_idx, tab in enumerate(tabs, 1):
            history = tab.get('history', [])
            if not history: continue

            page = history[-1]
            title = page.get('title', 'No Title')

            # Обрезаем слишком длинные заголовки
            if len(title) > 80: title = title[:77] + '...'

            marker = '' if tab.get('active') else ' '
            print(f'  {marker} {title}')

    print(f'\n  Total Tabs: {total_tabs}')

except Exception as e:
    print(f'Error reading session: {e}')
" "$(basename "$SESSION_FILE" .yml)"
  exit 0
fi

# ==============================================================================
# MAIN LOGIC
# ==============================================================================

TERMINAL="/opt/homebrew/bin/alacritty"
CONFIG_FILE="/Users/tim/dev/dotfiles/qutebrowser/alacritty-popup.toml"
FZF="/opt/homebrew/bin/fzf"
SELECT_FILE="/tmp/qute_session_selection"

# Очищаем файл выбора
rm -f "$SELECT_FILE"

# Если передан аргумент - используем его, иначе запускаем меню
if [ -n "$1" ]; then
  SESSION_NAME="$1"
else
  # Создаем скрипт-хелпер для запуска внутри Alacritty
  HELPER_SCRIPT="/tmp/qute_session_helper.sh"
  CURRENT_SCRIPT=$(realpath "$0")

  cat <<EOF >"$HELPER_SCRIPT"
#!/bin/bash
cd "$SESSION_DIR" || { echo "Directory not found: $SESSION_DIR"; read -p "Press Enter..."; exit 1; }

# Проверка, есть ли файлы
ls -1 *.yml >/dev/null 2>&1
if [ \$? -ne 0 ]; then
    echo "No .yml sessions found in:"
    pwd
    echo "Check permissions or path."
    read -p "Press Enter to close..."
    exit 1
fi

# Nord theme for fzf
export FZF_DEFAULT_OPTS="
--ansi
--height=100%
--border=none
--prompt=' '
--pointer=''
--marker=''
--info=inline
--color=fg:#d8dee9,bg:#2e3440,hl:#81a1c1
--color=fg+:#eceff4,bg+:#4c566a,hl+:#88c0d0
--color=info:#e5e9f0,prompt:#81a1c1,pointer:#bf616a
--color=marker:#a3be8c,spinner:#b48ead,header:#a3be8c
--color=gutter:#2e3440
--color=border:#4c566a,label:#81a1c1
"

# Запускаем fzf с превью
# Передаем текущий скрипт для генерации превью
ls -1 *.yml | sed 's/\.yml$//' | $FZF \
    --cycle \
    --prompt='Session > ' \
    --preview-window=right:70%:wrap \
    --preview "bash '$CURRENT_SCRIPT' --preview {}" \
    > "$SELECT_FILE"
EOF

  chmod +x "$HELPER_SCRIPT"

  # Запускаем терминал и ЖДЕМ его завершения
  # Используем специальный конфиг (без рамок, maximized, nord)
  CONFIG_FILE="/Users/tim/dev/dotfiles/qutebrowser/alacritty-session-add.toml"

  "$TERMINAL" \
    --config-file "$CONFIG_FILE" \
    --title "Qutebrowser Session" \
    -e "$HELPER_SCRIPT"

  # Читаем выбор
  if [ -f "$SELECT_FILE" ]; then
    SESSION_NAME=$(cat "$SELECT_FILE" | tr -d '\n')
  fi
fi

if [ -z "$SESSION_NAME" ]; then
  echo "message-info 'Cancelled'" >"$QUTE_FIFO"
  exit 0
fi

# Полный путь к сессии
if [[ "$SESSION_NAME" != *.yml ]]; then
  SESSION_FILE="$SESSION_DIR/$SESSION_NAME.yml"
else
  SESSION_FILE="$SESSION_DIR/$SESSION_NAME"
fi

if [ ! -f "$SESSION_FILE" ]; then
  echo "message-error 'Session file not found: $SESSION_NAME'" >"$QUTE_FIFO"
  exit 1
fi

# Используем Python для парсинга YAML и извлечения URL
# Пишем команды прямо в QUTE_FIFO
python3 -c "
import sys, yaml, os

try:
    with open('$SESSION_FILE', 'r') as f:
        data = yaml.safe_load(f)

    windows = data.get('windows', [])
    fifo = os.environ.get('QUTE_FIFO')

    if not fifo:
        print('Error: QUTE_FIFO not found', file=sys.stderr)
        sys.exit(1)

    count = 0
    with open(fifo, 'w') as f:
        for window in windows:
            urls = []
            for tab in window.get('tabs', []):
                if 'history' in tab and tab['history']:
                    last_entry = tab['history'][-1]
                    if 'url' in last_entry:
                        urls.append(last_entry['url'])

            if urls:
                # Первое окно
                f.write(f'open -w {urls[0]}\n')
                # Остальные табы
                for url in urls[1:]:
                    f.write(f'open -t {url}\n')
                count += 1

    # Сообщение об успехе (тоже в FIFO)
    with open(fifo, 'w') as f:
        f.write(f'message-info \"Restored {count} windows from $SESSION_NAME\"\n')

except Exception as e:
    with open(fifo, 'w') as f:
        f.write(f'message-error \"Error: {e}\"\n')
"
