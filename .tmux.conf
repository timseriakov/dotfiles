# Plugins
#
set -g @plugin 'tmux-plugins/tpm'

### https://github.com/tmux-plugins/tmux-sessionist
# - prefix + C - prompt for creating a new session by name.
# - prefix + X - kill current session without detaching tmux.
# - prefix + S - switches to the last session.
#                The same as built-in prefix + L that everyone seems to override with some other binding.
# - prefix + @ - promote current pane into a new session.
#                Analogous to how prefix + ! breaks current pane to a new window.
set -g @plugin 'tmux-plugins/tmux-sessionist'

### https://github.com/tmux-plugins/tmux-resurrect
# This plugin goes to great lengths to save and restore all the details from your tmux environment.
#
# Key bindings
#
# - prefix + Ctrl-s - save
# - prefix + Ctrl-r - restore
set -g @plugin 'tmux-plugins/tmux-resurrect'

set -g @plugin 'tmux-plugins/tmux-yank' # Copy to the system clipboard in tmux.
set -g @plugin 'akohlbecker/aw-watcher-tmux'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'

set -g @continuum-restore 'on'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'kitty'

# Theme
#
set -g @plugin 'arcticicestudio/nord-tmux'

set -g status-left-length 60
set -g status-left '#[fg=#2E3440,bg=#81A1C1,nobold] #S #[fg=#81A1C1,bg=#3B4252,nobold]#[default]'

# Bindings
#
# Shared helper to switch layout to English; safe to run even if im-select is missing.
set -g @switch_to_english_cmd "command -v im-select >/dev/null 2>&1 && im-select com.apple.keylayout.ABC >/dev/null 2>&1 || true"
# Keep the prefix window open roughly as long as tmux's default prefix-timeout (1s).
set -g @english_layout_prefix_timeout 1.5

# Disable tmux's built-in prefix handler so we can run our own hook.
set-option -g prefix None
unbind-key C-b
unbind-key C-a

# Pressing prefix twice still sends a literal Ctrl+A to the pane.
unbind-key -T prefix C-a
bind-key   -T prefix C-a send-keys C-a

# Custom prefix handler: switch to English and temporarily enter the prefix table.
bind-key -n C-a run-shell "#{@switch_to_english_cmd}" \;\
  switch-client -T prefix \;\
  run-shell -b "sleep #{@english_layout_prefix_timeout} && tmux switch-client -c '#{client_name}' -T root"

# Allow triggering the prefix from copy mode tables as well.
bind-key -T copy-mode C-a send-keys -X cancel \;\
  run-shell "#{@switch_to_english_cmd}" \;\
  switch-client -T prefix \;\
  run-shell -b "sleep #{@english_layout_prefix_timeout} && tmux switch-client -c '#{client_name}' -T root"

bind-key -T copy-mode-vi C-a send-keys -X cancel \;\
  run-shell "#{@switch_to_english_cmd}" \;\
  switch-client -T prefix \;\
  run-shell -b "sleep #{@english_layout_prefix_timeout} && tmux switch-client -c '#{client_name}' -T root"

# Ctrl-a r to reload this config
unbind r
bind r source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"
bind к source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"

set -g automatic-rename            on
set -g automatic-rename-format     '#{pane_current_command} /#{b:pane_current_path}'

# <Prefix> X for killing a session
bind-key X kill-session

# When creating a new window or pane, automatically change to the directory of
# the current window or pane. Switching back to English right before prompts
# avoids typing the window name in the wrong layout.
bind c run-shell "#{@switch_to_english_cmd}" \;\
        new-window -c "#{pane_current_path}"
bind '=' split-window -c "#{pane_current_path}"
bind Enter split-window -h -c "#{pane_current_path}"

# Settings
#
set-option -g status-position top
set-option -g renumber-windows on
set -g base-index 1


set-environment -g TMPDIR "$HOME/tmp"
set-option -g default-shell /opt/homebrew/bin/fish
set-option -g set-clipboard on
set -g mouse on

# Handle mouse clicks in normal mode:
# Trigger on MouseUp to ensure correct pane evaluation.
# - If pane is already active, pass the click directly to the application (e.g., for Neovim cursor positioning).
# - If pane is not active, select it and then pass the click.
bind-key -n MouseUp1Pane if-shell -F '#{==:#{pane_id},#{mouse_pane}}' 'send-keys -M' 'select-pane -t= ; send-keys -M'

setw -g aggressive-resize on
set -g @scroll-speed-num-lines-per-scroll "1"

# This is required for vim colors to work correctly when ssh-ing to one server,
# running tmux on it, and then in one pane ssh-ing to a different server. If
# this is not set, that latter pane will not have proper colors in vim.
set -g allow-passthrough on
set -as terminal-features 'xterm-kitty:passthrough'
set -g default-terminal "xterm-kitty"
set -ga terminal-overrides ",xterm-kitty:Tc"

# Apparently helps with nvim compatibility; not sure why this is needed
# Disabled: causes [O and [I characters to appear when switching windows
# Modern nvim versions work fine without this option
set -g focus-events off

# Helps with hitting escape key lag in vim
set -sg escape-time 0 # or maybe 10

# bigger history size
set -g history-limit 100000

# status messages displayed for this many milliseconds
set -g display-time 4000

# update status every this many seconds
set -g status-interval 5

# Move current window to specific index
# - Prefix + v → Insert before index (shift others)
unbind v
bind v command-prompt -p "Insert before:" "move-window -b -t ':%1'"

# Move current window to specific index
# - Prefix + b → Swap with index (exchange positions)
unbind b
bind b command-prompt -p "Swap with:" "swap-window -t ':%1'"

# Move current pane to chosen window
# - Prefix + m → Move to index (split 50/50)
unbind m
bind m command-prompt -p "Move to:" "join-pane -h -l 50% -t ':%1'"

# Pull pane from another window into current one
# - Prefix + M → Pull from index (split 50/50)
unbind M
bind M command-prompt -p "Pull from:" "join-pane -h -l 50% -s ':%1' -t :."

# Bind F1..F12 (sent from kitty)
# Cmd+t → kitty sends F1, so switch to English before creating the new window.
bind-key -n F1 run-shell "#{@switch_to_english_cmd}" \;\
             new-window -c "#{pane_current_path}"
bind-key -n F2 kill-pane
bind-key -n F3 kill-window
bind-key -n F4 split-window -h -c "#{pane_current_path}"
bind-key -n F5 resize-pane -Z

bind-key -n F6 command-prompt -I '#W' 'rename-window -- "%%"'

bind-key -n F9 previous-window
bind-key -n F10 next-window

bind-key -n F11 run-shell "~/.tmux/plugins/tmux-copycat/scripts/copycat_search.sh"
bind-key -n F12 run-shell "~/.tmux/plugins/tmux-copycat/scripts/copycat_mode_start.sh '(https?://|git@|git://|ssh://|ftp://|file:///)[[:alnum:]?=%/_.:,;~ @!#$&()*+-]*'"

# TPM
run '~/.tmux/plugins/tpm/tpm'

# remove unwanted pain-control binds
unbind |
unbind -
unbind \\
unbind _

# keep this line after run '~/.tmux/plugins/tpm/tpm'
set -g status-right ''

# Use vim keybindings for navigating copy mode
setw -g mode-keys vi

bind -T copy-mode-vi WheelUpPane send -N 1 -X scroll-up
bind -T copy-mode-vi WheelDownPane send -N 1 -X scroll-down

# Copy mode bindings - stay in copy mode after selection
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-no-clear
bind-key -T copy-mode-vi Enter send-keys -X copy-selection-no-clear

# Mouse selection stays in copy mode
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Override plugin bindings - must be after TPM
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear

# Click to focus pane even when current pane is in copy-mode
# Also clear any pending selection on click when target pane is in copy mode
unbind-key -T copy-mode-vi MouseDown1Pane
bind-key -T copy-mode-vi MouseDown1Pane select-pane -t= \; if-shell -F "#{pane_in_mode}" "send-keys -X clear-selection"

# Allow clicking on status line tabs to switch windows while in copy mode
bind-key -T copy-mode-vi MouseDown1Status select-window -t=
bind-key -T copy-mode-vi MouseDown3Status select-window -t=
bind-key -T copy-mode-vi MouseUp2Status kill-window -t=

# Ensure clicks on status line switch windows outside copy mode as well
unbind-key -n MouseDown1Status
unbind-key -n MouseDown3Status
unbind-key -n MouseUp1Status
unbind-key -n MouseUp3Status
unbind-key -n MouseDrag1Status
bind-key -n MouseDown1Status select-window -t=
bind-key -n MouseDown3Status select-window -t=
bind-key -n MouseUp1Status select-window -t=
bind-key -n MouseUp3Status select-window -t=
bind-key -n MouseDrag1Status select-window -t=

# Middle mouse button on status line closes window (like browser tabs)
bind-key -n MouseUp2Status kill-window -t=

bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi Enter send-keys -X copy-selection

bind-key -T copy-mode-vi й send-keys -X cancel
bind-key -T copy-mode-vi i send-keys -X cancel
bind-key -T copy-mode-vi a send-keys -X cancel
bind-key -T copy-mode-vi ш send-keys -X cancel
bind-key -T copy-mode-vi ф send-keys -X cancel
bind-key -T copy-mode-vi p send-keys -X cancel \; paste-buffer
bind-key -T copy-mode-vi C-v send-keys -X cancel \; paste-buffer

bind-key -T copy-mode-vi i send-keys -X clear-selection
bind-key -T copy-mode-vi ш send-keys -X clear-selection
bind-key -T copy-mode-vi a send-keys -X cancel
bind-key -T copy-mode-vi ф send-keys -X cancel

bind-key -T copy-mode-vi p send-keys -X cancel \; paste-buffer
bind-key -T copy-mode-vi з send-keys -X cancel \; paste-buffer
bind-key -T copy-mode-vi C-v send-keys -X cancel \; paste-buffer

# Selection highlighting color (Nord theme)
set -g mode-style "fg=#2E3440,bg=#a3be8c"

# sesh
unbind-key s
bind-key "s" run-shell "tmux run-shell \"sesh connect \\\"$(
  sesh list -t --icons | fzf-tmux -p 100%,100% \
    --no-sort --ansi \
    --border-label=' Sessions ' --prompt=' ' \
    --header='  ^a-all ^t-tmux ^g-cfgs ^s-find ^x-kill' \
    --bind='tab:down,btab:up' \
    --bind='ctrl-a:change-prompt( )+reload(sesh list --icons)' \
    --bind='ctrl-t:change-prompt( )+reload(sesh list -t --icons)' \
    --bind='ctrl-g:change-prompt( )+reload(sesh list -c --icons)' \
    --bind='ctrl-s:change-prompt( )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind='ctrl-x:execute(tmux kill-session -t {2..})+change-prompt( )+reload(sesh list -t --icons)' \
    --preview-window='right:65%' \
    --preview='sesh preview {}' \
    --color=border:#81A1C1 \
  )\\\"\"
"
